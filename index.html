<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Crash Map with Styled Dual Slider</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson@3"></script>
<style>
    body { margin: 0; background: #111; color: #fff; font-family: sans-serif; }
    svg { width: 100vw; height: 85vh; display: block; cursor: grab; }
    .dot { fill: red; stroke: white; stroke-width: 0.5px; }
    .country { fill: #222; stroke: #444; }
    #controls { height: 15vh; padding: 10px; background: #222; display: flex; flex-direction: column; justify-content: center; gap: 10px; }

    /* Slider container */
    #sliderContainer { display: flex; align-items: center; gap: 15px; }
    #sliderWrapper { position: relative; width: 300px; height: 20px; }

    /* Base slider track */
    #sliderWrapper input[type=range] {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        background: transparent;
        position: absolute;
        pointer-events: none;
    }

    /* Slider thumbs */
    #sliderWrapper input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        pointer-events: all;
        width: 16px;
        height: 16px;
        background: #fff;
        border-radius: 50%;
        cursor: pointer;
        border: none;
        position: relative;
        z-index: 2;
    }

    /* Firefox */
    #sliderWrapper input[type=range]::-moz-range-thumb {
        width: 16px;
        height: 16px;
        background: #fff;
        border-radius: 50%;
        cursor: pointer;
        border: none;
        position: relative;
        z-index: 2;
    }

    /* Slider track visual */
    #sliderTrack {
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: 8px;
        background: #444;
        border-radius: 4px;
        transform: translateY(-50%);
        z-index: 1;
    }

    #sliderRange {
        position: absolute;
        top: 50%;
        height: 8px;
        background: #f00;
        border-radius: 4px;
        transform: translateY(-50%);
        z-index: 1;
    }

</style>
</head>
<body>

<div id="controls">
    <div id="sliderContainer">
        <label>Year Range: <span id="yearLabel">1908 - 2009</span></label>
        <div id="sliderWrapper">
            <div id="sliderTrack"></div>
            <div id="sliderRange"></div>
            <input id="startYear" type="range" min="1908" max="2009" value="1908">
            <input id="endYear" type="range" min="1908" max="2009" value="2009">
        </div>
    </div>
</div>

<svg></svg>

<script>
const width = window.innerWidth;
const height = window.innerHeight * 0.85;

const svg = d3.select("svg");

const projection = d3.geoNaturalEarth1()
    .scale(width / 6)
    .translate([width / 2, height / 2]);

const path = d3.geoPath().projection(projection);
const g = svg.append("g");

const zoom = d3.zoom()
    .scaleExtent([1, 8])
    .on("zoom", (event) => {
        const {transform} = event;
        g.attr("transform", transform);
        g.selectAll("circle.dot").attr("r", 3 / transform.k);
    });
svg.call(zoom);

let allLocations = [];

const startSlider = document.getElementById("startYear");
const endSlider = document.getElementById("endYear");
const yearLabel = document.getElementById("yearLabel");
const sliderRange = document.getElementById("sliderRange");

function updateSliderRange() {
    const min = parseInt(startSlider.min);
    const max = parseInt(endSlider.max);
    const start = parseInt(startSlider.value);
    const end = parseInt(endSlider.value);

    // Calculate percentage positions for bar
    const thumbOffset = 16 / 2; // half thumb width in px
    const trackWidth = sliderWrapper.clientWidth - thumbOffset * 2;

    const percentStart = ((start - min) / (max - min)) * trackWidth + thumbOffset;
    const percentEnd = ((end - min) / (max - min)) * trackWidth + thumbOffset;

    sliderRange.style.left = percentStart + "px";
    sliderRange.style.width = (percentEnd - percentStart) + "px";
}


// Load map + CSV
Promise.all([
    fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(r => r.json()),
    d3.dsv(";", "crashes_data_test.csv")
])
.then(([worldData, crashData]) => {

    // Detect columns
    const keys = Object.keys(crashData[0]);
    const latKey = keys.find(k => k.toLowerCase().includes("lat"));
    const lonKey = keys.find(k => k.toLowerCase().includes("lon"));
    const dateKey = keys.find(k => k.toLowerCase().includes("date"));

    if (!latKey || !lonKey || !dateKey) { console.error("Missing lat/lon/date columns"); return; }

    allLocations = crashData.map(d => {
        let rawLat = (d[latKey] ?? "").toString().trim().replace(",", ".");
        let rawLon = (d[lonKey] ?? "").toString().trim().replace(",", ".");
        rawLat = rawLat.replace(/[^\d.\-]/g, "");
        rawLon = rawLon.replace(/[^\d.\-]/g, "");

        let lat = parseFloat(rawLat);
        let lon = parseFloat(rawLon);

        let year = null;
        if (d[dateKey]) {
            let dt = new Date(d[dateKey]);
            if (!isNaN(dt)) year = dt.getFullYear();
        }

        return { lat, lon, year };
    }).filter(d =>
        !isNaN(d.lat) && !isNaN(d.lon) &&
        d.lat >= -90 && d.lat <= 90 &&
        d.lon >= -180 && d.lon <= 180 &&
        d.year
    );

    // Draw map
    const countries = topojson.feature(worldData, worldData.objects.countries);
    g.append("path")
        .datum(countries)
        .attr("d", path)
        .attr("class", "country");

    // Initial draw
    drawDots(parseInt(startSlider.value), parseInt(endSlider.value));
    updateSliderRange();

    function update() {
        let start = parseInt(startSlider.value);
        let end = parseInt(endSlider.value);
        if (start > end) start = end;
        if (end < start) end = start;
        startSlider.value = start;
        endSlider.value = end;
        yearLabel.textContent = `${start} - ${end}`;
        drawDots(start, end);
        updateSliderRange();
    }

    startSlider.addEventListener("input", update);
    endSlider.addEventListener("input", update);

});

// Draw dots filtered by year
function drawDots(startYear, endYear) {
    const filtered = allLocations.filter(d => d.year >= startYear && d.year <= endYear);

    const dots = g.selectAll("circle.dot")
        .data(filtered, d => d.lat + "-" + d.lon + "-" + d.year);

    dots.join(
        enter => enter.append("circle")
            .attr("class", "dot")
            .attr("r", 3)
            .attr("cx", d => projection([d.lon, d.lat])[0])
            .attr("cy", d => projection([d.lon, d.lat])[1]),
        update => update,
        exit => exit.remove()
    );
}
</script>

</body>
</html>
